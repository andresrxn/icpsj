---
import StudieCard from '@/components/studies/StudieCard.astro'
import Heading from '@/components/typography/Heading.astro'
import Text from '@/components/typography/Text.astro'
import { getI18N } from '@/i18n'
import { getLangFromUrl } from '@/i18n/utils'
import RootLayout from '@/layouts/RootLayout.astro'
import { capitalize, formatSlug } from '@/utils/articles'
import { generateSiteTitle } from '@/utils/meta'
import { getCollection } from 'astro:content'

const lang = getLangFromUrl(Astro.url)
const i18n = getI18N({ currentLocale: lang })

const { slug } = Astro.params
if (slug === undefined) {
  throw new Error('Slug is required')
}
const posts = (
  await getCollection('studies', entry => {
    return (
      entry.slug.startsWith(lang) &&
      entry.data.book.toLocaleLowerCase() === slug.toLocaleLowerCase()
    )
  })
).sort((a, b) => b.data.createdAt.valueOf() - a.data.createdAt.valueOf())
if (posts.length === 0) return Astro.redirect('/404')
---

<RootLayout
  title={generateSiteTitle(i18n.books.meta.title)}
  description={i18n.books.meta.description}>
  <main>
    <section class='py-32 lg:pt-44'>
      <div class='container-grid'>
        <Heading size='sm' tablet='base'
          >{i18n.common.labels.bookOf} {' '} {capitalize(slug)}</Heading
        >
        <div class='flex items-center gap-8 mt-8'>
          <Text tv='lg' type='label' class='text-primary-base'>{posts.length}</Text>
          <Text tv='lg'>{i18n.common.labels.booksFound}</Text>
        </div>
      </div>
    </section>
    <section class='bg-surface pt-32 pb-60'>
      <div class='container-grid grid gap-32 md:grid-cols-2 md:gap-x-16 lg:grid-cols-3 mt-24'>
        {
          posts.map(post => {
            const formatedSlug = formatSlug(post.slug)

            return (
              <StudieCard
                book={post.data.book}
                createdAt={post.data.createdAt}
                updatedAt={post.data.updatedAt}
                slug={formatedSlug}
                title={post.data.title}
                description={post.data.description}
                imageSrc={post.data.imageSrc}
                imageAlt={post.data.imageAlt}
              />
            )
          })
        }
      </div>
    </section>
  </main>
</RootLayout>
